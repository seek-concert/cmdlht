<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="__CSS__/style.css"/>
    <link type="text/css" rel="stylesheet" href="__CSS__/liandong.css">
</head>
<body>
<div id="navtab1" style="width: 1000px; margin-top: -36px;">
        <table class="layerTable" border="0">
            <input type="hidden" id="pidtxt" name="p_id" value="{$info.p_id}"/>
            <tr class="h30">
                <td>产品名称：</td>
                <td>
                    <input class="must" type="text" name="p_name" id="pnametxt" value="{$info.p_name}"/>
                </td>
                <td>商家：</td>
                <td>
                    <select name="p_uid" id="puid" onchange="bidcid(this)">
                        <volist name="userinfo_info" id="userinfoinfo">
                            <option value="{$userinfoinfo.u_id}"
                            <eq name="userinfoinfo.u_id" value="$info.p_uid">selected</eq>
                            ><empty name="userinfoinfo.u_shopname">商户ID：{$userinfoinfo.u_id}</empty>{$userinfoinfo.u_shopname}</option>
                        </volist>
                    </select>
                </td>
            </tr>
            <tr class="h30">
                <td>品牌：</td>
                <td>
                    <select name="p_bid" id="pbid">
                        <option value="">-----请选择-----</option>
                        <volist name="brand_info" id="brandinfo">
                            <option value="{$brandinfo.b_id}"
                            <eq name="brandinfo.b_id" value="$info.p_bid">selected</eq>
                            >{$brandinfo.b_name}</option>
                        </volist>
                    </select>
                </td>
                <td>单位：</td>
                <td>
                    <select name="p_cid" id="pcid">
                        <option value="">-----请选择-----</option>
                        <volist name="company_info" id="companyinfo">
                            <option value="{$companyinfo.c_id}"
                            <eq name="companyinfo.c_id" value="$info.p_cid">selected</eq>
                            >{$companyinfo.c_name}</option>
                        </volist>
                    </select>
                </td>
            </tr>
            <tr class="h30">
                <td>上下架：</td>
                <td>
                    <select name="p_state" id="pstate">
                        <option value="1"
                        <eq name="info.p_state" value="1">selected</eq>
                        >上架</option>
                        <option value="0"
                        <eq name="info.p_state" value="0">selected</eq>
                        >下架</option>
                    </select>
                </td>
                <td>是否删除：</td>
                <td>
                    <select name="p_del" id="pdel">
                        <option value="1"
                        <eq name="info.p_del" value="1">selected</eq>
                        >删除</option>
                        <option value="0"
                        <eq name="info.p_del" value="0">selected</eq>
                        >正常</option>
                    </select>
                </td>
            </tr>
            <tr class="h30">
                <td>产品类型：</td>
                <td>
                    <select name="p_type" id="ptype">
                        <option value="0">请选择</option>
                        <volist name="alist" id="vo">
                            <option value="{$vo.pt_id}"
                            <eq name="vo.pt_id" value="$info.p_type">selected</eq>
                            >
                            {:str_repeat(" |-",$vo['count']-2)}
                            {$vo['pt_receptionname']}
                            </option>
                        </volist>
                    </select>
                </td>
                <td>卖点：</td>
                <td>
                    <input class="must" type="text" name="p_sellingpoint" id="psellingpoint"
                           value="{$info.p_sellingpoint}"/>
                </td>
            </tr>
            <tr class="h25">
                <td>APP图片：</td>
                <td colspan="3">
                    <form enctype="multipart/form-data" method="post" id="img1">
                        <div class="imgadds imgadds1" style="margin-top:10px;width: 520px;">
                            <volist name="imgs" id="imgs1">
                                <img src='{$imgs1}' width='150px;' height='150px;' style='float:left;margin:0 0 0 0px;'>
                                <img src='__IMG__/trash.png' class='delthis'  onclick='delimgs1(this)'
                                     style='float:left;margin-top:0px;margin-right: 2px;'>
                            </volist>
                        </div>
                        <div class="imgCon " colspan="5" style="position: relative;height: 150px;width: 150px;float: left;padding: 0px !important;">
                            <div class="uopImg upBtn upload-btn-a" data-type="avatar" data-is_edit="1" data-inited="1">
                                <img src="__PUBLIC__/img/addimg.png" width="150px;" height="150px;" style="float:left;">
                                <input class="upload-input" type="file" size="100" name="upload_file" id="uploadFile"
                                       onchange="uploadImage(this);">
                            </div>
                        </div>
                    </form>
                </td>
            </tr>
            <tr class="h25">
                <td>PC图片：</td>
                <td colspan="3">
                    <form enctype="multipart/form-data" method="post" id="img2">
                        <div class="imgadds imgadds2" style="margin-top:10px;width: 520px;">
                            <volist name="pcimgs" id="imgs2">
                                <img src='{$imgs2}' width='150px;' height='150px;' style='float:left;margin:0 0 0 0px;'>
                                <img src='__IMG__/trash.png' class='delthis'  onclick='delimgs1(this)'
                                     style='float:left;margin-top:0px;margin-right: 2px;'>
                            </volist>
                        </div>
                        <div class="imgCon " colspan="5" style="position: relative;height: 150px;width: 150px;float: left;padding: 0px !important;">
                            <div class="uopImg upBtn upload-btn-a" data-type="avatar" data-is_edit="1" data-inited="1">
                                <img src="__PUBLIC__/img/addimg.png" width="150px;" height="150px;" style="float:left;">
                                <input class="upload-input" type="file" size="100" name="upload_file" id="uploadFile3"
                                       onchange="uploadImage(this);">
                            </div>
                        </div>
                    </form>
                </td>
            </tr>
            <tr class="h30">
                <td>商品描述：</td>
                <td colspan="3" style="padding: 0;">
                    <textarea id="contenttxt" name="p_content" style="width: 750px; height: 300px;">
                        {$info.p_content}
                    </textarea>
                </td>
            </tr>
            <tr class="h30">
                <td>搜索关键字：</td>
                <td>
                    <div class="Hui-tags">
                        <volist name="searchkeyword_info" id="searchinfo">
                            <span class="Hui-tags-token">{$searchinfo}</span>
                        </volist>
                        <div class="Hui-tags-iptwrap">
                            <input type="text" class="Hui-tags-input" name="p_searchkeyword" maxlength="20" value="">
                            <label class="Hui-tags-label">添加相关标签，用空格或回车分隔</label>
                        </div>
                    </div>
                </td>
                <td>有无活动：</td>
                <td>
                    <select name="p_isactivity" id="pisactivity" onclick="displaytypes()">
                        <option value="1"
                        <eq name="info.p_isactivity" value="1">selected</eq>
                        >有活动</option>
                        <option value="0"
                        <eq name="info.p_isactivity" value="0">selected</eq>
                        >无活动</option>
                    </select>
                </td>
            </tr>
        </table>
        <div id="search-form-div" style="display: none;">
            <table class="layerTable" border="0">
                <tr class="h30">
                    <td>活动名称：</td>
                    <td colspan="3">
                        <input class="must" type="text" name="p_activityname" id="pactivityname" value=""/>
                    </td>
                </tr>
                <tr class="h30">
                    <td>活动开始时间：</td>
                    <td>
                        <input type="text" name="p_activitystartime" class="Wdate" onFocus="WdatePicker({lang:'zh-cn'})"
                               id="pactivitystartime" value=""/>
                    </td>
                    <td>活动结束时间：</td>
                    <td>
                        <input type="text" name="p_activityendtime" class="Wdate" onFocus="WdatePicker({lang:'zh-cn'})"
                               id="pactivityendtime" value=""/>
                    </td>
                </tr>
            </table>
        </div>
        <div style="padding: 35px 8px; border: 1px solid #A3C0E8;" class="div_content">
            <div class="div_title"><span style="font-weight: bold;">产品属性：</span>&nbsp;&nbsp;&nbsp;
                <button id="insertbutton" onclick="insertattributevalue()">添加属性</button>&nbsp;&nbsp;&nbsp;
                <button id="modifybutton" onclick="modifyattributevalue()">修改属性</button>
            </div>
            <hr/>
            <div class="div_contentlist" style="display: none;">
                <volist name="typenameinfo" id="typename">
                    <ul class="Father_Title">
                        <li><span>{$typename}：</span>&nbsp;&nbsp;&nbsp;<input id="Checkbox{$i}" class="newvals"
                                                                              type="text" value="" placeholder="请输入{$typename}"/>&nbsp;<button
                                onclick="insertvals(this)">添加{$typename}
                        </button>
                        </li>
                    </ul>
                    <ul class="Father_Item{$i-1}">

                    </ul>
                    <br/>
                    <hr/>
                </volist>
            </div>
            <div class="div_contentlist3" style="display: none;">
                <ul>
                    <li>
                        <div id="createTable1">
                            <table id="process" style="width:100%;padding:5px;" cellspacing="0" cellpadding="1"
                                   border="1">
                                <thead>
                                <tr>
                                    <volist name="typenameinfo" id="typename">
                                    <th style="width:10%;">{$typename}</th>
                                    </volist>
                                    <th style="width:10%;">价格</th>
                                    <th style="width:10%;">库存</th>
                                    <th style="width:10%;">活动价</th>
                                    <th style="width:10%;">原价</th>
                                    <th style="width:10%;">APP图上传</th>
                                    <th style="width:10%;">PC图上传</th>
                                    <th style="width:10%;">操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                <volist name="productattributevalueinfo" id="productattributevalueinfos">
                                    <tr>
                                        <volist  name="typenameinfo" id="typename" key="k">
                                            <td>{$productattributevalueinfos.1.$typename}</td>
                                        </volist>
                                        <td>
                                            <input class="l-text" value="{$productattributevalueinfos.0.atv_price|number_format=2}" onkeyup="keyup_this(this)" type="text">
                                            <input name="Txt_PriceSon" class="l-text" value="{$productattributevalueinfos.0.atv_price}" type="hidden">
                                        </td>
                                        <td>
                                            <input class="l-text" value="{$productattributevalueinfos.0.atv_stock|number_format=2}" onkeyup="keyup_this(this)" type="text">
                                            <input name="Txt_CountSon" class="l-text" value="{$productattributevalueinfos.0.atv_stock}" type="hidden">
                                        </td>
                                        <td>
                                            <input class="l-text" value="{$productattributevalueinfos.0.atv_activityprice|number_format=2}" onkeyup="keyup_this(this)" type="text">
                                            <input name="Txt_NumberSon" class="l-text" value="{$productattributevalueinfos.0.atv_activityprice}" type="hidden">
                                        </td>
                                        <td>
                                            <input class="l-text" value="{$productattributevalueinfos.0.atv_originalprice|number_format=2}" onkeyup="keyup_this(this)" type="text">
                                            <input name="Txt_SnSon" class="l-text" value="{$productattributevalueinfos.0.atv_originalprice}" type="hidden">
                                        </td>
                                        <td>
                                            <form enctype="multipart/form-data" method="post" id="img11">
                                                <div class="imgCon " colspan="5"  style="position: relative;height: 50px;width: 50px;">
                                                    <div class="uopImg upBtn upload-btn-a" data-type="avatar"  data-is_edit="1" data-inited="1">
                                                        <img src="/public/img/addimg.png" style="float: left;"  width="50px;" height="50px;">
                                                        <input  class="upload-input" size="100" name="upload_file"
                                                            id="uploadFile1" onchange="uploadImages(this);" type="file">
                                                    </div>
                                                </div>
                                            </form>
                                            <div class="imgadd appimg"  style="margin-top:10px;">
                                                <img src='{$productattributevalueinfos.0.atv_img}' width='50px;' height='50px;' style='float:left;margin:0 0 0 0px;'>
                                                <img src='__IMG__/trash.png' class='delthis' onclick="delimgs(this)"
                                                     style='float:left;margin-top:0px;margin-right: 2px;'>
                                            </div>
                                        </td>
                                        <td>
                                            <form enctype="multipart/form-data" method="post" id="img111">
                                                <div class="imgCon " colspan="5" style="position: relative;height: 50px;width: 50px;">
                                                    <div class="uopImg upBtn upload-btn-a" data-type="avatar"  data-is_edit="1" data-inited="1">
                                                        <img src="/public/img/addimg.png"  style="float: left;"  width="50px;" height="50px;">
                                                        <input  class="upload-input" size="100" name="upload_file"
                                                            id="uploadFile2" onchange="uploadImages(this);" type="file">
                                                    </div>
                                                </div>
                                            </form>
                                            <div class="imgadd pcimg"  style="margin-top:10px;">
                                                <img src='{$productattributevalueinfos.0.atv_pcimg}' width='50px;' height='50px;' style='float:left;margin:0 0 0 0px;'>
                                                <img src='__IMG__/trash.png' class='delthis' onclick="delimgs(this)"
                                                     style='float:left;margin-top:0px;margin-right: 2px;'>
                                            </div>
                                        </td>
                                        <td><button class="del_vals" onclick="del_val('{$productattributevalueinfos.0.atv_id}')">删除</button>&nbsp;&nbsp;&nbsp;</td>
                                    </tr>
                                </volist>
                                </tbody>
                            </table>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="div_contentlist2">
                <ul>
                    <li>
                        <div id="createTable"></div>
                    </li>
                </ul>
            </div>
        </div>

        <!--<div style="padding: 35px 8px; border: 1px solid #00a0e9;">-->
            <!--<div>-->
                <!--<span style="font-weight: bold;">产品参数：</span><br/>-->
                <!--<span><input id="newsname" type="text" value="" placeholder="请输入参数名"/>：-->
                               <!--<input id="newsval" type="text" value="" placeholder="请输入参数值"/>&nbsp;-->
                               <!--<button id="insertnewval">添加新参数</button>-->
                                <!--<button id="delnewval"-->
                                        <!--onclick="document.getElementById('newsname').value='';document.getElementById('newsval').value=''">清空</button></span>-->
            <!--</div>-->
            <!--<hr/>-->
            <!--<div id="newparameter">-->
                <!--<volist name="ppval" id="ppvals">-->
                     <!--<span>{$ppvals.val}:{$ppvals.name}<a id='dels'>删除参数</a></span>&nbsp;&nbsp;-->
                <!--</volist>-->
            <!--</div>-->
        <!--</div>-->
    <div class="layerBtns1" id="bt1" style="display:none">
        <a class="btn" onclick="ajaxform_modify()">提交</a>
    </div>
    <div class="layerBtns1" id="bt2" style="display:none">
        <a class="btn" onclick="ajaxform_insert()">提交</a>
    </div>
</div>
<script src="__JS__/jquery2-1-4.min.js" type="text/javascript" charset="utf-8"></script>
<script src="__LAYER__/layer.js" type="text/javascript" charset="utf-8"></script>
<script src="__JS__/htglxt.js" type="text/javascript" charset="utf-8"></script>
<script src="__JS__/iframe.js" type="text/javascript" charset="utf-8"></script>
<script src="__JS__/jquery.treetable.js" type="text/javascript" charset="utf-8"></script>
<script src="__JS__/ajax-submit.js"></script>
<script src="__JS__/My97DatePicker/WdatePicker.js"></script>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/kindeditor-4.1.10/themes/default/default.css"/>
<script src="__PUBLIC__/kindeditor-4.1.10/kindeditor-all-min.js" type="text/javascript" charset="utf-8"></script>
<script src="__PUBLIC__/kindeditor-4.1.10/lang/zh-CN.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="__JS__/liandong.js"></script>
<script type="text/javascript" src="__JS__/json2.js"></script>
<script>
    function del_val(delval) {
        if($('.del_vals').length<=1){
            layer.msg('已是最后一条属性，禁止删除！', { icon: 1, time: 1000 });
            return false;
        }
        layer.confirm('删除须谨慎，确认要删除吗？', function (index) {
            $.ajax({
                type: "post",
                url: "{:U('dels')}",
                data: {  atv_id: delval  },
                dataType: "json",
                success: function (e) {
                    layer.msg(e.info, { icon: 1, time: 1000 });
                    window.location.reload();
                },
                error: function (e) {
                    layer.msg(e.info, { icon: 1, time: 1000 });
                }
            });

        });
    }

    /*显示价格*/
    function keyup_this(obj) {
        var _this = $(obj).val();
       $(obj).next('input').val(_this);
    }

    if($("#pbid").html()==""){
        $("#pbid").html("<option value=''>暂无</option>");
    }
    if($("#pcid").html()==""){
        $("#pcid").html("<option value=''>暂无</option>");
    }
    /*==========文本编辑器部分============*/
    KindEditor.ready(function(K) {
        window.editor1 = K.create('#contenttxt',{
            width : '100%',
            height:'440',
            uploadJson : "{:U('index/ajaxuploads')}",
            allowFileManager : true,
            items:['source', '|', 'undo', 'redo', '|', 'preview', 'print', 'template', 'code', 'cut', 'copy', 'paste',
                'plainpaste', 'wordpaste', '|', 'justifyleft', 'justifycenter', 'justifyright',
                'justifyfull', 'insertorderedlist', 'insertunorderedlist', 'indent', 'outdent', 'subscript',
                'superscript', 'clearhtml', 'quickformat', 'selectall', '/',
                'formatblock', 'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold',
                'italic', 'underline', 'strikethrough', 'lineheight', 'removeformat', '|', 'image', 'multiimage',
                'flash', 'media', 'insertfile', 'table', 'hr', 'emoticons', 'baidumap', 'pagebreak',
                'anchor', 'link', 'unlink', '|', 'about'],
            afterBlur:function () {
                $('#contenttxt').val(editor1.html());
            }
        });
    });
    /*====图片上传-预览====*/
    function uploadImage(obj) {
        /*判断是否有选择上传文件*/
        var imgPath = obj.files;
        /* console.log(imgPath);*/
        if (!imgPath.length) {
            layer.msg('请选择需要上传的图片!', {icon: 1, time: 1000});
            return;
        }
        /*判断APP张数*/
        var ucardedimg = $(obj).parents('td').find(".imgadds1").find('img').length;
        if(ucardedimg>=8){
            layer.msg('APP图片只能上传四张!', {icon: 1, time: 1000});
            return;
        }
        /*判断pc张数*/
        var ucardedimg1 = $(obj).parents('td').find(".imgadds2").find('img').length;
        if(ucardedimg1>2){
            layer.msg('PC图片只能上传两张!', {icon: 1, time: 1000});
            return;
        }
        var parent_obj = $(obj).parents('td'),
            addimgs = parent_obj.find('.imgadds');

        var ccccc = new FormData();
        ccccc.append('upload_file', imgPath[0]);
        $.ajax({
            type: "POST",
            url: "{:U('banner/ajaxupload')}",
            data: ccccc,
            processData: false,
            contentType: false,
            success: function (data) {
                addimgs.append("<img src='" + data.url + "'  width='150px;' height='150px;' style='float:left;margin:0 0 0 0px;'><img src='/Public/img/trash.png'  onclick='delimgs1(this)' class='delthis' style='float:left;margin-top:0px;margin-right: 2px;'> ");
                layer.msg(data.info, {icon: 1, time: 1000});
            },
            error: function (e) {
                layer.msg(e.info, {icon: 1, time: 1000});
            }
        });
    }
    /*====删除预览图片====*/
    function delimgs1(omg){
        $(omg).prev().remove();
        $(omg).remove();
    }
    /*====表格中图片上传-预览====*/
    function uploadImages(obj) {
        /*判断是否有选择上传文件*/
        var imgPath = obj.files;
        /* console.log(imgPath);*/
        if (!imgPath.length) {
            layer.msg('请选择需要上传的图片!', {icon: 1, time: 1000});
            return;
        }
        /*判断APP张数*/
        var ucardedimg1 = $(obj).parents('td').find(".appimg").find('img').length;
        if(ucardedimg1>=1){
            layer.msg('APP图片只能上传一张!', {icon: 1, time: 1000});
            return;
        }
        /*判断pc张数*/
        var ucardedimg1 = $(obj).parents('td').find(".pcimg").find('img').length;
        if(ucardedimg1>=1){
            layer.msg('PC图片只能上传一张!', {icon: 1, time: 1000});
            return;
        }
        var parent_obj = $(obj).parents('td'),
            addimgs = parent_obj.find('.imgadd');

        var ccccc = new FormData();
        ccccc.append('upload_file', imgPath[0]);

        $.ajax({
            type: "POST",
            url: "{:U('banner/ajaxupload')}",
            data: ccccc,
            processData: false,
            contentType: false,
            success: function (data) {
                addimgs.append("<img src='" + data.url + "'  width='50px;' height='50px;' style='float:left;margin:0 0 0 0px;'><img src='/Public/img/trash.png' onclick='delimgs(this)' class='delthis' style='float:left;margin-top:0px;margin-right: 2px;'> ");
                layer.msg(data.info, {icon: 1, time: 1000});
            },
            error: function (e) {
                layer.msg(e.info, {icon: 1, time: 1000});
            }
        });
    }
    /*====表格删除预览图片====*/
    function delimgs(omg) {
        $(omg).prev().remove();
        $(omg).remove();
    }
    /*==========产品属性---添加或者修改选择============*/
    function insertattributevalue(){
        $(".div_contentlist").show();
        $(".div_contentlist2").show();
        $(".div_contentlist3").hide();
        $("#bt1").hide();
        $("#bt2").show();
    }
    function modifyattributevalue() {
        $(".div_contentlist3").show();
        $(".div_contentlist").hide();
        $(".div_contentlist2").hide();
        $("#bt1").show();
        $("#bt2").hide();
    }

    /*打开网页执行*/
    window.onload = function () {
        displaytypes();
        modifyattributevalue();
    };

    /*商家品牌与单位的联动查询*/
    function bidcid(obj) {
        var a = $(obj).val();
        var data = {
            'p_uid':a
        };
        $.ajax({
            type: "post",
            url: "{:U('index/search_bidcid')}",
            data: data,
            dataType: "json",
            success: function (e) {
                if(e!=","){
                    $("#pbid").html(e[0]);
                    $("#pcid").html(e[1]);
                    if($("#pbid").html()==""){
                        $("#pbid").html("<option value=''>暂无</option>");
                    }
                    if($("#pcid").html()==""){
                        $("#pcid").html("<option value=''>暂无</option>");
                    }
                }else{
                    $("#pbid").html("<option value=''>暂无</option>");
                    $("#pcid").html("<option value=''>暂无</option>");
                }

            },
            error: function () {
                layer.alert('操作失败！');
            }
        });
    }
    /*选中类型---显示与隐藏*/
    function displaytypes() {
        var pttype = $("#pisactivity").val();
        if (pttype == '0') {
            $("#search-form-div").hide();
        }
        if (pttype == '1') {
            $("#search-form-div").show();
        }
    }
    /*=====点击添加新属性的值====*/
    function insertvals(obj) {
        var newval = $(obj).parents("li").find(".newvals").val();
        if($.trim(newval)){
            $(obj).parents(".Father_Title").next("ul").append('<li class="li_width" style="float: left;"><label><input  type="checkbox" class="chcBox_Width" value="'+newval+'" />'+newval+'<span class="li_empty"> </span></label></li>');
        }else{
            layer.alert("值不能为空");
        }
       }

    /*====产品的修改-添加属性值ajax部分====*/
    function ajaxform_insert() {
        /*===========获取产品值===========*/
        var pid = $("#pidtxt").val();
        var pname = $("#pnametxt").val();
        var pcid = $("#pcid option:selected").val();
        var pbid = $("#pbid option:selected").val();
        var puid = $("#puid option:selected").val();
        var pstate = $("#pstate option:selected").val();
        var pdel = $("#pdel option:selected").val();
        var pcontent = editor1.html();
        var ptype = $("#ptype option:selected").val();
        var psellingpoint = $("#psellingpoint").val();
        /*获取APP图片*/
        var pimglist = "";
        $(".imgadds1").find("img").each(function () {
            pimglist += $(this).attr("src") + ",";
            pimglist =  pimglist.replace(',/Public/img/trash.png',"");
        });
        if (pimglist.length > 0) pimglist = pimglist.substr(0, pimglist.length - 1);
        /*获取PC图片*/
        var ppcimglist = "";
        $(".imgadds2").find("img").each(function () {
            ppcimglist += $(this).attr("src") + ",";
            ppcimglist =  ppcimglist.replace(',/Public/img/trash.png',"");
        });
        if (ppcimglist.length > 0) ppcimglist = ppcimglist.substr(0, ppcimglist.length - 1);

        /*获取关键字*/
        var psearchkeyword = "";
        $(".Hui-tags-token").each(function () {
            psearchkeyword += $(this).text() + " ";
        });

        var pisactivity = $("#pisactivity option:selected").val();
        var pactivityname = $("#pactivityname").val();
        var pactivitystartime = $("#pactivitystartime").val();
        var pactivityendtime = $("#pactivityendtime").val();
        if (pisactivity == '0') {
            pactivityname = "0";
            pactivitystartime = "0";
            pactivityendtime = "0";
        }
        /*===============获取添加模板---产品属性值============*/
        /*获取类型名称的值*/
        var typenamearray = [];
        $("#createTable table tr th").each(function (i) {
            $(this).each(function (i) {
                typenamearray.push($(this).text());
            });
            /*去掉不需要的字段*/
            for (var i = 0; i <= typenamearray.length - 1; i++) {
                if (typenamearray[i] == '价格' || typenamearray[i] == '库存' || typenamearray[i] == '活动价' || typenamearray[i] == '原价' || typenamearray[i] == 'APP图上传'|| typenamearray[i] == 'PC图上传') {
                    typenamearray.splice(i, 1);
                }
            }
        });
        var typename = $(typenamearray).stringify();

        /*获取类型名称+类型值*/
        var tablearray = [];
        var typenames = [];
        var typevals = [];
        var atvtypevalue = [];
        $("#createTable table tr:gt(0)").each(function (i) {
            $("#createTable table tr th").each(function (j) {
                typenames.push($(this).text());
            });
            $(this).children("td").each(function (i) {
                typevals.push($(this).text());
            });
            for (var i = 0; i < typenames.length; i++) {
                tablearray[i] = typenames[i] + ":" + typevals[i];
            }
            for (var h = 0; h <= tablearray.length - 1; h++) {
                if (tablearray[h] == '价格:') {
                    tablearray.splice(h, 1);
                }
                if (tablearray[h] == '活动价:') {
                    tablearray.splice(h, 1);
                }
                if (tablearray[h] == '库存:') {
                    tablearray.splice(h, 1);
                }
                if (tablearray[h] == '原价:') {
                    tablearray.splice(h, 1);
                }
                if (tablearray[h] == 'APP图上传:  ') {
                    tablearray.splice(h, 1);
                }
                if (tablearray[h] == 'PC图上传:  ') {
                    tablearray.splice(h, 1);
                }
            }
            for (var m = 0; m <= tablearray.length - 1; m++) {
                if (tablearray[m] == '活动价:') {
                    tablearray.splice(m, 1);
                }
                if (tablearray[m] == 'APP图上传:   ') {
                    tablearray.splice(m, 1);
                }
                if (tablearray[m] == 'PC图上传:   ') {
                    tablearray.splice(m, 1);
                }
            }
            var p = tablearray.length / typenamearray.length;
            var typevalue = [];
            for (var i = 0; i < p; i++) {
                var lk = [];
                for (var n = 0; n < tablearray.length; n++) {
                    if (n >= (i) * typenamearray.length && n < ((i + 1) * typenamearray.length)) {
                        lk.push(tablearray[n]);
                    }
                }
                typevalue.push(lk);
            }
            /*转换成字符串*/
            atvtypevalue = $(typevalue).stringify();
        });
        /*获取input的值*/
        var price = "";
        var stock = "";
        var activityprice = "";
        var originalprice = "";
        var atvimg = "";
        var atvpcimg = "";
        $("#createTable table tr:gt(0)").each(function (j) {
            /*获取input价格的值*/
            $(this).children("td").children("input[name=Txt_PriceSon]").each(function (l) {
                price += $(this).val() + ",";
            });
            /*获取input库存的值*/
            $(this).children("td").children("input[name=Txt_CountSon]").each(function (i) {
                stock += $(this).val() + ",";
            });
            /*获取input活动价的值*/
            $(this).children("td").children("input[name=Txt_NumberSon]").each(function (k) {
                activityprice += $(this).val() + ",";
            });
            /*获取input原价的值*/
            $(this).children("td").children("input[name=Txt_SnSon]").each(function (h) {
                originalprice += $(this).val()+",";
            });
            /*获取APP图片的值*/
            $(this).children("td").children(".appimg").find("img").each(function (n) {
                atvimg += $(this).attr("src") + ",";
                atvimg =  atvimg.replace(',/Public/img/trash.png',"");
            });
            /*获取PC图片的值*/
            $(this).children("td").children(".pcimg").find("img").each(function (n) {
                atvpcimg += $(this).attr("src") + ",";
                atvpcimg =  atvpcimg.replace(',/Public/img/trash.png',"");
            });
        });
        if (price == "" || stock == "" || activityprice == "" || originalprice == "" || atvimg == ""|| atvpcimg == "") {
            layer.msg('产品属性输入不完整,请输入后再提交!', {icon: 2, time: 1500});
            return;
        }
        /*===============获取参数值===============*/
    /*    var parameter = "";
        $("#newparameter span a").text("");
        $("#newparameter span").each(function (j) {
            parameter += $(this).text() + ",";
        });
        if (parameter == "") {
            layer.msg('添加参数为空,请添加后再提交!', {icon: 2, time: 1500});
            return;
        }*/
        /*=========组合获取值===========*/
        var data = {
            /*产品的值*/
            'p_id':pid,
            'p_name': pname,
            'p_cid': pcid,
            'p_bid': pbid,
            'p_uid': puid,
            'p_state': pstate,
            'p_del': pdel,
            'p_content': pcontent,
            'p_type': ptype,
            'p_sellingpoint': psellingpoint,
            'p_imglist': pimglist,
            'p_searchkeyword': psearchkeyword,
            'p_isactivity': pisactivity,
            'p_activityname': pactivityname,
            'p_activitystartime': pactivitystartime,
            'p_activityendtime': pactivityendtime,
            'p_pcimglist': ppcimglist,
            /*产品属性值*/
            'atv_stock': stock,
            'atv_price': price,
            'atv_img': atvimg,
            'atv_pcimg': atvpcimg,
            'atv_activityprice': activityprice,
            'atv_typename': typename,
            'atv_typevalue': atvtypevalue,
            'atv_originalprice': originalprice,
            // /*产品参数值*/
            // 'pp_pid': pid,
            // 'pp_val': parameter
        };
        var index = layer.load({shade: [0.5, '#fff']});
        $.ajax({
            type: "post",
            url: "{:U('product/modify')}",
            data: data,
            dataType: "json",
            success: function (e) {
                layer.close(index);
                if (e.status == 1) {
                    layer.msg(e.info);
                    window.parent.location.reload();
                }
                if (e.status == 0) {
                    layer.msg(e.info);
                }
            },
            error: function () {
                layer.close(index);
                layer.alert('操作失败！');
            }
        });
    }

    /*====产品的修改-修改属性值ajax部分====*/
    function ajaxform_modify() {
        /*===========获取产品值===========*/
        var pid = $("#pidtxt").val();
        var pname = $("#pnametxt").val();
        var pcid = $("#pcid option:selected").val();
        var pbid = $("#pbid option:selected").val();
        var puid = $("#puid option:selected").val();
        var pstate = $("#pstate option:selected").val();
        var pdel = $("#pdel option:selected").val();
        var pcontent = editor1.html();
        var ptype = $("#ptype option:selected").val();
        var psellingpoint = $("#psellingpoint").val();
        /*获取APP图片*/
        var pimglist = "";
        $(".imgadds1").find("img").each(function () {
            pimglist += $(this).attr("src") + ",";
            pimglist =  pimglist.replace(',/Public/img/trash.png',"");
        });
        if (pimglist.length > 0) pimglist = pimglist.substr(0, pimglist.length - 1);

        /*获取PC图片*/
        var ppcimglist = "";
        $(".imgadds2").find("img").each(function () {
            ppcimglist += $(this).attr("src") + ",";
            ppcimglist =  ppcimglist.replace(',/Public/img/trash.png',"");
        });
        if (ppcimglist.length > 0) ppcimglist = ppcimglist.substr(0, ppcimglist.length - 1);
        /*获取关键字*/
        var psearchkeyword = "";
        $(".Hui-tags-token").each(function () {
            psearchkeyword += $(this).text() + " ";
        });

        var pisactivity = $("#pisactivity option:selected").val();
        var pactivityname = $("#pactivityname").val();
        var pactivitystartime = $("#pactivitystartime").val();
        var pactivityendtime = $("#pactivityendtime").val();
        if (pisactivity == '0') {
            pactivityname = "0";
            pactivitystartime = "0";
            pactivityendtime = "0";
        }
        /*===============获取添加模板---产品属性值============*/

        /*获取input的值*/
        var price = "";
        var stock = "";
        var activityprice = "";
        var originalprice = "";
        var atvimg = "";
        var atvpcimg = "";
        $("#createTable1 table tr:gt(0)").each(function (j) {
            /*获取input价格的值*/
            $(this).children("td").children("input[name=Txt_PriceSon]").each(function (l) {
                price += $(this).val() + ",";
            });
            /*获取input库存的值*/
            $(this).children("td").children("input[name=Txt_CountSon]").each(function (i) {
                stock += $(this).val() + ",";
            });
            /*获取input活动价的值*/
            $(this).children("td").children("input[name=Txt_NumberSon]").each(function (k) {
                activityprice += $(this).val() + ",";
            });
            /*获取input原价的值*/
            $(this).children("td").children("input[name=Txt_SnSon]").each(function (h) {
                originalprice += $(this).val()+",";
            });
            /*获取APP图片的值*/
            $(this).children("td").children(".appimg").find("img").each(function (n) {
                atvimg += $(this).attr("src") + ",";
                atvimg =  atvimg.replace(',/Public/img/trash.png',"");
            });
            /*获取PC图片的值*/
            $(this).children("td").children(".pcimg").find("img").each(function (n) {
                atvpcimg += $(this).attr("src") + ",";
                atvpcimg =  atvpcimg.replace(',/Public/img/trash.png',"");
            });
        });
        if (price == "" || stock == "" || activityprice == "" || originalprice == "" || atvimg == ""|| atvpcimg == "") {
            layer.msg('产品属性输入不完整,请输入后再提交!', {icon: 2, time: 1500});
            return;
        }
        /*===============获取参数值===============*/
     /*   var parameter = "";
        $("#newparameter span a").text("");
        $("#newparameter span").each(function (j) {
            parameter += $(this).text() + ",";
        });*/
        /*=========组合获取值===========*/
        var data = {
            /*产品的值*/
            'p_id':pid,
            'p_name': pname,
            'p_cid': pcid,
            'p_bid': pbid,
            'p_uid': puid,
            'p_state': pstate,
            'p_del': pdel,
            'p_content': pcontent,
            'p_type': ptype,
            'p_sellingpoint': psellingpoint,
            'p_imglist': pimglist,
            'p_pcimglist': ppcimglist,
            'p_searchkeyword': psearchkeyword,
            'p_isactivity': pisactivity,
            'p_activityname': pactivityname,
            'p_activitystartime': pactivitystartime,
            'p_activityendtime': pactivityendtime,
            /*产品属性值*/
            'atv_stock': stock,
            'atv_price': price,
            'atv_img': atvimg,
            'atv_pcimg': atvpcimg,
            'atv_activityprice': activityprice,
            'atv_originalprice': originalprice,
            // /*产品参数值*/
            // 'pp_pid': pid,
            // 'pp_val': parameter
        };
        var index = layer.load({shade: [0.5, '#fff']});
        $.ajax({
            type: "post",
            url: "{:U('product/modify')}",
            data: data,
            dataType: "json",
            success: function (e) {
                layer.close(index);
                if (e.status == 1) {
                    layer.msg(e.info);
                    window.parent.location.reload();
                }
                if (e.status == 0) {
                    layer.msg(e.info);
                }
            },
            error: function () {
                layer.close(index);
                layer.alert('操作失败！');
            }
        });
    }
    /*=====点击添加新的参数====*/
   /* $("#insertnewval").click(function () {
        var newname = $("#newsname").val();
        var newval = $("#newsval").val();
        if($.trim(newname)&&$.trim(newval)){
            $("#newparameter").append("<span>" + newname + ":" + newval + "<a id='dels' href='javascript:void(0)'>删除参数</a></span>&nbsp;&nbsp;");
        }else{
            layer.alert("请输入参数和参数值");
        }
    });*/
    /*=====点击删除参数====*/
 /*   $("#newparameter").on("click", '#dels', function () {
        $(this).parent("span").remove();
    });*/
    /*-----搜索关键字效果部分--------*/
    var time1;
    $(".Hui-tags-lable").show();
    $(".Hui-tags-input").val("");
    $(document).on("blur", ".Hui-tags-input", function () {
        time1 = setTimeout(function () {
            $(this).parents(".Hui-tags").find(".Hui-tags-list").slideUp();
        }, 400);
    });
    $(document).on("focus", ".Hui-tags-input", function () {
        clearTimeout(time1);
    });
    $(document).on("click", ".Hui-tags-input", function () {
        $(this).find(".Hui-tags-input").focus();
        $(this).find(".Hui-tags-list").slideDown();
    });
    function gettagval(obj) {
        var str = "";
        var token = $(obj).parents(".Hui-tags").find(".Hui-tags-token");
        //alert(token.length)
        if (token.length < 1) {
            $(obj).parents(".Hui-tags").find(".Hui-tags-val").val("");
            return false;
        }
        for (var i = 0; i < token.length; i++) {
            str += token.eq(i).text() + ",";
            $(obj).parents(".Hui-tags").find(".Hui-tags-val").val(str);
        }
    }
    $(document).on("keydown", ".Hui-tags-input", function (event) {
        $(this).next().hide();
        var v = $(this).val().replace(/\s+/g, "");
        var reg = /^,|,$/gi;
        v = v.replace(reg, "");
        v = $.trim(v);
        var token = $(this).parents(".Hui-tags").find(".Hui-tags-token");
        if (v != '') {
            if (event.keyCode == 13 || event.keyCode == 108 || event.keyCode == 32) {
                $('<span class="Hui-tags-token">' + v + '</span>').insertBefore($(this).parents(".Hui-tags").find(".Hui-tags-iptwrap"));
                $(this).val("");
                gettagval(this);
            }
        } else {
            if (event.keyCode == 8) {
                if (token.length >= 1) {
                    $(this).parents(".Hui-tags").find(".Hui-tags-token:last").remove();
                    gettagval(this);
                }
                else {
                    $(this).parents(".Hui-tags").find(".Hui-tags-lable").show();
                    return false;
                }

            }
        }
    });
    $(document).on("click", ".Hui-tags-has span", function () {
        var taghasV = $(this).text();
        taghasV = taghasV.replace(/(^\s*)|(\s*$)/g, "");
        $('<span class="Hui-tags-token">' + taghasV + '</span>').insertBefore($(this).parents(".Hui-tags").find(".Hui-tags-iptwrap"));
        gettagval(this);
        $(this).parents(".Hui-tags").find(".Hui-tags-input").focus();
    });
    $(document).on("click", ".Hui-tags-token", function () {
        var token = $(this).parents(".Hui-tags").find(".Hui-tags-token");
        var it = $(this).parents(".Hui-tags");
        $(this).remove();
        switch (token.length) {
            case 1 :
                it.find(".Hui-tags-lable").show();
                break;
        }
        var str = "";
        var token = it.find(".Hui-tags-token");
        //alert(token.length)
        if (token.length < 1) {
            it.find(".Hui-tags-val").val("");
            return false;
        }
        for (var i = 0; i < token.length; i++) {
            str += token.eq(i).text() + ",";
            it.find(".Hui-tags-val").val(str);
        }
    });
</script>
</body>
</html>
